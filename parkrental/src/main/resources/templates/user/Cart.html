<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .product-image {
            width: 30px;
            height: 30px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .table td {
            padding: 10px;
            vertical-align: middle;
        }
        .quantity-input {
            display: inline-flex;
            align-items: center;
        }
        .quantity-input input {
            width: 70px;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .flatpickr-day--prevMonthDay, .flatpickr-day--nextMonthDay {
            opacity: 0.3;
        }
        .sunday {
            color: red;
        }
        .text-center-modal {
            text-align: center;
        }
        .form-control::placeholder {
            color: #999;
        }
        .modal-body .form-control {
            text-align: center;
        }
    </style>
</head>
<body>
<h1 class="text-center">장바구니 목록</h1>

<div class="container my-4">
    <table class="table table-hover">
        <thead>
        <tr>
            <th>상품 이름</th>
            <th>가격</th>
            <th>합계</th>
            <th>선택 수량</th>
            <th>재고</th>
            <th>공원 이름</th>
            <th>삭제</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="cart : ${cartProducts}">
            <td>
                <img th:src="@{'/image/rental/' + ${cart.productName.toLowerCase()} + '.png'}"
                     alt="Product Image" style="width: 40px; height: 40px; margin-right: 10px; vertical-align: middle;">
                <span th:text="${cart.productName}">상품 이름</span>
            </td>
            <td th:text="${cart.productPrice}">가격</td>
            <td id="total_product_${cart.idx}" th:text="${cart.productPrice * cart.quantity}">합계</td>
            <td>
                <div class="quantity-input">
                    <input type="number" class="form-control"
                           min="1" th:max="${cart.product.quantity}"
                           th:value="${cart.quantity}"
                           th:id="'quantity_' + ${cart.idx}"
                           th:onchange="'updateProductTotal(' + ${cart.idx} + ', ' + ${cart.productPrice} + ')'">
                </div>
            </td>
            <td th:text="${cart.product.quantity}">재고</td>
            <td th:data-parkid="${cart.product != null && cart.product.parkList != null ? cart.product.parkList.parkId : ''}"
                th:text="${cart.product != null && cart.product.parkList != null ? cart.product.parkList.parkNm : '정보 없음'}">
                공원 이름
            </td>
            <td>
                <button class="btn btn-Secondary btn-sm" th:onclick="deleteProduct([[${cart.idx}]])">
                    <i class="bi bi-x-square"></i>
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="text-center mb-4">
        <strong>총 합계 금액 : </strong> <span id="totalPrice" th:text="${totalPrice} + ' 원'"></span>
    </div>

    <div class="text-center">
        <button type="button" id="updateQuantityBtn" class="btn btn-primary">수량 변경</button>
        <button type="button" class="btn btn-warning" onclick="validateParks()">예약하기</button>
        <button type="button" class="btn btn-secondary" onclick="history.back()">이전 페이지</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function updateProductTotal(idx, price) {
        const quantityElement = document.getElementById('quantity_' + idx);
        const totalElement = document.getElementById('total_product_' + idx);

        if (quantityElement && totalElement) {
            const quantityValue = parseInt(quantityElement.value, 10);
            const productTotal = price * quantityValue;
            totalElement.innerText = productTotal;
        }

        updateTotalPrice();
    }

    function updateTotalPrice() {
        let totalPrice = 0;

        document.querySelectorAll('td[id^="total_product_"]').forEach(product => {
            totalPrice += parseInt(product.innerText, 10); // 소수점 제거
        });

        document.getElementById('totalPrice').innerText = totalPrice + ' 원';
    }

    function updateQuantities() {
        const payload = [];

        document.querySelectorAll('input[type="number"]').forEach(input => {
            const id = input.getAttribute('id');
            if (id) {
                const idx = id.split('_')[1];
                const quantityValue = input.value;

                if (quantityValue > 0) {
                    const data = {
                        idx: parseInt(idx, 10),
                        quantity: parseInt(quantityValue, 10)
                    };
                    payload.push(data);
                }
            }
        });

        fetch(`/user/Cart/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('네트워크 응답 에러 발생.');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert('수량이 변경되었습니다.');
                location.reload();
            }
        })
        .catch(error => {
            console.error('수량 변경 에러 발생 :', error);
        });
    }

    // 이벤트 리스너를 통해 수량 변경 버튼을 클릭할 때 updateQuantities 호출
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('updateQuantityBtn').addEventListener('click', updateQuantities);

        flatpickr("#reservationDate", {
            dateFormat: "Y-m-d",
            locale: {
                firstDayOfWeek: 0
            },
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                if (dayElem.classList.contains("flatpickr-day--prevMonthDay") || dayElem.classList.contains("flatpickr-day--nextMonthDay")) {
                    dayElem.style.opacity = "0.3";
                    dayElem.classList.remove('sunday');
                } else {
                    if (dayElem.dateObj.getDay() === 0) {
                        dayElem.classList.add('sunday');
                    } else {
                        dayElem.classList.remove('sunday');
                    }
                }
            },
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    const dayName = ['일', '월', '화', '수', '목', '금', '토'][new Date(dateStr).getDay()];
                    document.getElementById('reservationDate').value = `${dateStr} (${dayName})`;
                }
            }
        });

        const totalCartAmount = document.getElementById('totalPrice').innerText;
        document.getElementById('cartTotalAmountText').innerText = totalCartAmount;
    });

    function validateParks() {
        const parkIds = [];
        document.querySelectorAll('td[data-parkid]').forEach(parkElement => {
            const parkId = parkElement.getAttribute('data-parkid');
            if (parkId) {
                parkIds.push(parkId);
            }
        });

        const uniqueParkIds = [...new Set(parkIds)];
        if (uniqueParkIds.length > 1) {
            alert('여러 공원의 물품이 선택되었습니다.\n한 공원의 물품만 대여 가능합니다.');
            return;
        }

        // 공원이 동일하면 모달창을 띄움
        const reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));
        reservationModal.show();
    }

    // 이벤트 리스너를 통해 예약하기 버튼을 클릭할 때 validateParks 호출
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('updateQuantityBtn').addEventListener('click', updateQuantities);
        document.getElementById('reserveBtn').addEventListener('click', validateParks);  // 예약하기 버튼 이벤트 리스너
    });


    // 기존 함수들 유지

    function deleteProduct(idx) {
        if (confirm('이 물품을 삭제하시겠습니까?')) {
            fetch(`/user/Cart/delete/${idx}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('네트워크 응답 에러 발생');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('물품이 삭제되었습니다.');
                    location.reload();
                }
            })
            .catch(error => {
                console.error('물품 삭제 에러 발생 :', error);
            });
        }
    }

    // 이벤트 리스너를 통해 삭제 버튼을 클릭할 때 deleteProduct 호출
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('updateQuantityBtn').addEventListener('click', updateQuantities);
        document.getElementById('reserveBtn').addEventListener('click', validateParks);  // 예약하기 버튼 이벤트 리스너

        // 삭제 버튼에 이벤트 리스너 연결
        document.querySelectorAll('button.deleteProductBtn').forEach(button => {
            const idx = button.getAttribute('data-idx');  // 버튼에 data-idx 속성으로 idx 값을 설정
            button.addEventListener('click', function () {
                deleteProduct(idx);
            });
        });
    });
</script>

</body>
</html>
